{{ define "body_classes" }}project root list-view{{ end }}

{{ define "main" }}
  {{/* Diseño especial para la página principal de Projects */}}
    <div class="container">
      <div class="d-flex flex-wrap justify-content-between align-items-center">
        <div class="projects-header">
          <h1 class="projects-title mb-1">{{ .Title }}</h1>
            {{ $sections := slice }}
              {{ range .Pages }}
                {{ if and .IsSection (gt (len .Pages) 0) }}
                  {{ $sections = $sections | append . }}
                {{ end }}
            {{ end }}
          <p class="projects-meta mb-0">
            <span>{{ len .Pages }}</span> projects
          </p>
        </div>
        <div class="view-toggle btn-group" role="group" aria-label="Cambiar vista">
          <button class="btn btn-outline-secondary" id="btnGrid">
            <i class="bi bi-grid-3x3-gap-fill"></i> Cuadrícula
          </button>
          <button class="btn active-view btn-outline-primary" id="btnList">
            <i class="bi bi-list-ul"></i> Lista
          </button>
        </div>
      </div>
    </div>
  {{/* Combinar sections (secciones de projects) y projects (páginas regulares de projects) */}}
  {{ $currentPage := . }}
  
  {{/* Obtener las sections (subsecciones de projects) */}}
  {{ $sections := .Sections }}
  
  {{/* Obtener solo los projects que están directamente en /projects/ (sin section) */}}
  {{ $uncategorizedProjects := where .RegularPages "Section" "projects" }}
  
  {{/* Combinar sections y projects sin section */}}
  {{ $allItems := $sections | union $uncategorizedProjects }}

  {{/* Crear una lista con fechas efectivas para ordenamiento */}}
  {{ $itemsWithDates := slice }}
  {{ range $allItems }}
    {{ $effectiveDate := .Date }}
    {{ if .IsSection }}
      {{/* Para sections, usar la fecha del project más reciente */}}
      {{ if .Pages }}
        {{ $latestPage := index (sort .Pages "Date" "desc") 0 }}
        {{ $effectiveDate = $latestPage.Date }}
      {{ end }}
    {{ end }}
    {{ $itemsWithDates = $itemsWithDates | append (dict "item" . "effectiveDate" $effectiveDate) }}
  {{ end }}

  {{/* Ordenar por fecha efectiva de más reciente a más antiguo */}}
  {{ $sortedItems := sort $itemsWithDates "effectiveDate" "desc" }}
  
  {{/* Extraer solo los items ordenados */}}
  {{ $allItems = slice }}
  {{ range $sortedItems }}
    {{ $allItems = $allItems | append .item }}
  {{ end }}


  {{/* Crear el paginador aquí en el template principal */}}
  {{ $paginator := .Paginate $allItems }}

  {{/* Calcular total de artículos y categorías para el header del parcial */}}
  {{ $totalProjects := len .Pages }}
  {{ $rootSections := slice }}
  {{ range .Pages }} {{/* Iterar sobre .Pages de la página actual (root) para encontrar secciones directas */}}
    {{ if and .IsSection (gt (len .Pages) 0) }}
      {{ $rootSections = $rootSections | append . }}
    {{ end }}
  {{ end }}
  {{ $totalCategories := len $rootSections }}

  {{/* Sección Unificada de Sections y Projects con toggle */}}
  {{ if gt (len $allItems) 0 }}
      {{ partial "projects_grid_list.html" (dict
          "Paginator" $paginator
          "Context" .
          "ViewContainerClass" "unified-view-container"
          "ShowHeader" true
          "ShowViewButtons" true
          "TotalProjects" $totalProjects
          "TotalCategories" $totalCategories
      ) }}
    
  {{ else }}
  <div class="container py-5 text-center">
    <p>No hay contenido disponible en esta sección.</p>
  </div>
  {{ end }}
{{ end }}